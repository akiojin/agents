# AGENTS.md

このファイルは、エージェントがこのリポジトリでコードを扱う際のガイダンスを提供します。

## コミュニケーションガイドライン

- 回答は必ず日本語

## 開発指針

- 設計・実装は複雑にせずに、シンプルさの極限を追求してください。
- エラーが発生している状態で完了としないこと。必ずエラーが解消された時点で完了とする。

## 実装要件

**重要: 実装時は必ず以下の要件ドキュメントを確認し、遵守すること**

## 開発ワークフロー

### 基本ルール

- プランモードで承認を得た後は、現在のブランチまたはユーザーが指定した環境で作業を開始する
- 作業（タスク）を完了したら、変更点をコミットログに追加して、コミット＆プッシュを必ず行う
- 作業（タスク）は、最大限の並列化をして進める
- 作業（タスク）は、最大限の細分化をしてToDoに登録する
- 作業（タスク）の開始前には、必ずToDoWtieでToDoを登録した後に作業を開始する
- 作業（タスク）は、git flowのルールに従う
- 作業（タスク）は、現在の作業ディレクトリで行う。ユーザーが明示的にworktreeの使用を指示した場合のみworktreeで作業する。
- 作業（タスク）は、git worktreeの元のブランチは、特別な理由がない限りdevelopを指定する。
- 作業（タスク）をworktreeでは、必ずそのブランチで作業を行う。mainおよびdevelopブランチでの作業は絶対に禁止。
- 作業（タスク）の完了後は、作業内容をプッシュして、必ずdevelopブランチにPRを出す。
- 作業（タスク）を出す前には、必ずdevelopの最新版をマージする。
- 作業（タスク）でPRを出した後は、PRがマージされるまでworktreeを保持する。PRがマージされたら、速やかにworktreeを削除する。
- 作業（タスク）は、忖度なしで進める
- 作業（タスク）は、必ずPRまで実行する

### 重要: AIによるWorktree操作の制限

**AIは以下の操作を自動的に行ってはいけない：**

- `git worktree add`コマンドの実行
- `git worktree remove`コマンドの実行
- 新しいworktreeディレクトリへの移動

**AIが実行可能な操作：**

- 現在の作業ディレクトリでのブランチ作成・切り替え（`git checkout -b`、`git switch`）
- ユーザーが明示的に指示した場合のworktree操作
- 既存のworktree内での作業（ユーザーが既にそのディレクトリにいる場合）

## 外部連携

- `context7` MCP を使用して、最新のNext.js、Node.js、およびその他のライブラリを確認してください。
- `google-search`MCPウェブ検索を使用して、最新の解決策を検索できます。
- `microsoft.docs.mcp`MCPを使用して、最新の.NETなどやAzureの、マイクロソフトのドキュメントを確認してください。
- `openai`MCPを使用して、画像生成をすることができます。

## Serena MCPツールの使用

**重要: コード探索と編集にはSerenaツールを優先的に使用すること**

### 基本方針

- **ファイル全体の読み取りを避ける**: `Read`ツールでファイル全体を読む代わりに、Serenaのシンボリックツールを使用
- **効率的なコード探索**: 必要な部分のみを読み取ることでトークン使用量を削減
- **精密な編集**: シンボル単位またはパターンベースの編集で正確な変更を実現

### 推奨ツール使用順序

#### 1. コード探索時

1. `mcp__serena__get_symbols_overview` - ファイル/ディレクトリの構造把握
2. `mcp__serena__find_symbol` - 特定のクラス/メソッドの検索（include_body=false）
3. `mcp__serena__find_symbol` - 必要な部分のみ読み取り（include_body=true）
4. `mcp__serena__find_referencing_symbols` - 参照関係の把握

#### 2. コード編集時

**シンボル全体の変更:**

- `mcp__serena__replace_symbol_body` - クラス/メソッド全体の置換
- `mcp__serena__insert_before_symbol` - インポート文の追加など
- `mcp__serena__insert_after_symbol` - 新規メソッド/クラスの追加

**部分的な変更:**

- `mcp__serena__replace_regex` - ワイルドカードを活用した効率的な置換
  - 小さな変更: エスケープした元のコードを直接置換
  - 大きな変更: `.*?`を使って中間部分を省略

#### 3. ファイル検索時

- `mcp__serena__find_file` - ファイル名のパターン検索
- `mcp__serena__search_for_pattern` - コード内容のパターン検索
- `mcp__serena__list_dir` - ディレクトリ構造の確認

### GitHub操作に関する重要事項

**重要: git/ghコマンドではなく、必ずgithub MCPを使用すること**

- gitコマンドでは認証が通らない可能性があるが、github MCPであれば確実に認証が通る
- PRの作成、ブランチの操作、リポジトリの管理など、すべてのGitHub操作はgithub MCPを通じて行う
- ローカルのgitコマンドは最小限に留め、GitHub上の操作が必要な場合は必ずgithub MCPを使用する

## ドキュメント管理

- ドキュメントはルートディレクトリに配置してはいけない。必ずdocs/配下に配置する

## コードクオリティガイドライン

- マークダウンファイルはmarkdownlintでエラー及び警告がない状態にする
- コミットログはcommitlintに対応する
- 設計書や仕様書など、ソースファイル以外のドキュメントに、ソースコードを極力書いてはいけない。
- ソースコードのコメントは全て日本語で記載する

## AIエージェント向けコーディング規約

**重要: CI/CDエラーを防ぐため、以下の規約を厳格に遵守すること**
**これらの規約違反がCI/CDエラーの主要因です。必ず遵守してください。**

## 開発ガイドライン

- 既存のファイルのメンテナンスを無視して、新規ファイルばかり作成するのは禁止。既存ファイルを改修することを優先する。

## インフラストラクチャガイドライン

- GitHub Actionsで使用するホストランナーはself-hosted/macOSのみ許可
- self-hostedランナーは組織に登録されているため、常にself-hostedを使用する

## ブランチ管理

- ブランチ保護ルールの更新は.github/config/以下のファイルを更新して、`gh repo-config apply`で行う。
- ブランチ保護ルールは`gh repo-config apply`で行う。
